# Implementation Tasks: Multi-Agent Coordination System

**Feature**: 001-multi-agent-coordination
**Branch**: `001-multi-agent-coordination`
**Date**: 2026-02-14
**Generated by**: `/speckit.tasks`

## Overview

This document provides a complete, dependency-ordered task breakdown for implementing the Multi-Agent Coordination System. Tasks are organized by user story to enable independent implementation and testing of each feature increment.

**Total Tasks**: 87
**MVP Scope**: Phase 3 (User Story 1) + Phase 4 (User Story 4) = **25 tasks**
**Parallelization Opportunities**: 42 tasks marked [P] can run in parallel

---

## Implementation Strategy

### MVP-First Approach

The recommended implementation order follows the Priority P1 user stories:

1. **Phase 1-2**: Setup and Foundation (9 tasks) - Blocking prerequisites
2. **Phase 3**: User Story 1 - Agent Task Coordination (P1) - Core functionality
3. **Phase 4**: User Story 4 - Secure Agent Communication (P1) - Security essentials
4. **Phase 5+**: Remaining user stories (P2, P3) - Feature completeness

**MVP Delivery**: Phases 1-4 provide a fully functional, secure agent coordination system.

### Independent Story Testing

Each user story phase includes:
- **Story Goal**: What value this story delivers
- **Independent Test**: How to validate the story works standalone
- **Implementation Tasks**: All code needed for this story
- **No external dependencies**: Can be implemented without waiting for other stories (except foundational phase)

---

## Dependency Graph

```
Phase 1 (Setup)
    ↓
Phase 2 (Foundation)
    ↓
    ├─→ Phase 3: User Story 1 (P1) - Agent Task Coordination
    │       ↓
    ├─→ Phase 4: User Story 4 (P1) - Secure Communication
    │       ↓
    ├─→ Phase 5: User Story 5 (P2) - Agent Onboarding
    │       ↓
    ├─→ Phase 6: User Story 2 (P2) - Human Observer
    │       ↓
    └─→ Phase 7: User Story 3 (P3) - Config & Setup
            ↓
        Phase 8: Polish & Integration
```

**Key**: P1 stories (Phases 3-4) are MVP. P2/P3 stories (Phases 5-7) add features incrementally.

---

## Phase 1: Project Setup

**Goal**: Initialize project structure, dependencies, and development environment

**Duration**: ~2-4 hours

### Tasks

- [x] T001 Create monorepo structure with packages/mcp-server/ and packages/relay-server/
- [x] T002 [P] Initialize MCP Server (TypeScript): package.json with dependencies (discord.js, @microsoft/signalr, ioredis, @octokit/rest, zod, yaml)
- [x] T003 [P] Initialize Relay Server (C#/.NET): Create solution file packages/relay-server/CoorChat.RelayServer.sln
- [x] T004 [P] Setup TypeScript configuration in packages/mcp-server/tsconfig.json (target ES2022, module ESNext, strict mode)
- [x] T005 [P] Create Dockerfile for MCP Server in packages/mcp-server/Dockerfile (multi-stage build, Alpine base)
- [x] T006 [P] Create Dockerfile for Relay Server in packages/relay-server/Dockerfile
- [x] T007 Setup GitHub Actions workflow .github/workflows/mcp-server-ci.yml (build, test, publish to DockerHub)
- [x] T008 [P] Setup GitHub Actions workflow .github/workflows/relay-server-ci.yml
- [x] T009 Create docker-compose.yml for local development environment

**Completion Criteria**: All project structures exist, dependencies installable, Docker builds succeed

---

## Phase 2: Foundational Layer

**Goal**: Implement core abstractions and protocols that all user stories depend on

**Duration**: ~8-12 hours

**Why Foundation First**: These components are used by ALL user stories, so they must be complete before any story implementation.

### Protocol & Message Infrastructure

- [x] T010 [P] Define Message interface and types in packages/mcp-server/src/protocol/Message.ts (protocolVersion, messageType enum, all fields from message-protocol.json)
- [x] T011 [P] Implement MessageBuilder fluent API in packages/mcp-server/src/protocol/MessageBuilder.ts
- [x] T012 [P] Implement MessageValidator using JSON schema in packages/mcp-server/src/protocol/MessageValidator.ts
- [x] T013 [P] Implement VersionManager for protocol versioning in packages/mcp-server/src/protocol/VersionManager.ts (backward compatibility for 1 major version)

### Channel Abstraction Layer

- [x] T014 Create Channel interface in packages/mcp-server/src/channels/base/Channel.ts (connect, disconnect, sendMessage, onMessage methods)
- [x] T015 [P] Implement ChannelFactory in packages/mcp-server/src/channels/base/ChannelFactory.ts (Strategy pattern, creates Discord/SignalR/Redis/Relay channels)
- [x] T016 [P] Create ChannelAdapter base class in packages/mcp-server/src/channels/base/ChannelAdapter.ts (common functionality: reconnection, error handling)

### Core Entities

- [x] T017 [P] Define Agent interface in packages/mcp-server/src/agents/Agent.ts (id, role, platform, environment, capabilities, status, timestamps)
- [x] T018 [P] Define Task interface in packages/mcp-server/src/tasks/Task.ts (id, description, assignedAgents, status, dependencies, GitHub references)
- [x] T019 [P] Define Capability interface in packages/mcp-server/src/agents/Capability.ts (per capability-schema.json)

### Configuration Management

- [x] T020 Create ConfigLoader in packages/mcp-server/src/config/ConfigLoader.ts (load JSON/YAML, environment variable substitution)
- [x] T021 [P] Create ConfigValidator using Zod in packages/mcp-server/src/config/ConfigValidator.ts (validate config schema from plan.md)
- [x] T022 [P] Create EnvironmentResolver in packages/mcp-server/src/config/EnvironmentResolver.ts (resolve ${VAR_NAME} syntax)

### Logging Infrastructure

- [x] T023 [P] Create Logger interface in packages/mcp-server/src/logging/Logger.ts (ERROR, WARN, INFO, DEBUG levels)
- [x] T024 [P] Implement LogFormatter in packages/mcp-server/src/logging/LogFormatter.ts (structured JSON logging)

**Completion Criteria**: Protocol defined, channel abstraction complete, entities modeled, config system working, logging operational

---

## Phase 3: User Story 1 - Agent Task Coordination (Priority P1)

**Story Goal**: Enable multiple specialized agents to coordinate work on shared tasks in real-time via GitHub integration

**Independent Test**:
1. Start two agents (developer and tester roles)
2. Create GitHub issue in connected repository
3. Verify developer agent receives task notification
4. Developer sends task_started message
5. Verify tester agent sees status update
6. Developer sends task_completed message
7. Verify tester agent receives completion notification

**Test Command**: `npm run test:integration -- --grep="Agent Task Coordination"`

### GitHub Integration

- [x] T025 [P] [US1] Implement GitHubClient wrapper in packages/mcp-server/src/github/GitHubClient.ts (using @octokit/rest, auth with token)
- [x] T026 [P] [US1] Implement WebhookHandler in packages/mcp-server/src/github/WebhookHandler.ts (Express endpoint, signature validation, parse issue/PR events)
- [x] T027 [P] [US1] Implement PollingService in packages/mcp-server/src/github/PollingService.ts (fallback polling with 30s interval, conditional requests with ETags)
- [x] T028 [US1] Implement SyncManager in packages/mcp-server/src/github/SyncManager.ts (orchestrate webhook + polling, deduplicate events, map issues → tasks)

### Task Management

- [x] T029 [P] [US1] Implement TaskQueue in packages/mcp-server/src/tasks/TaskQueue.ts (FIFO queue, task assignment logic)
- [x] T030 [P] [US1] Implement ConflictResolver in packages/mcp-server/src/tasks/ConflictResolver.ts (timestamp-based first-come-first-served)
- [x] T031 [P] [US1] Implement DependencyTracker in packages/mcp-server/src/tasks/DependencyTracker.ts (track task dependencies, notify when dependencies complete)

### Agent Registry

- [x] T032 [P] [US1] Implement AgentRegistry in packages/mcp-server/src/agents/AgentRegistry.ts (track connected agents, add/remove, get by ID/role)
- [x] T033 [P] [US1] Implement RoleManager in packages/mcp-server/src/agents/RoleManager.ts (extensible role definitions, validate custom roles)

### Channel Implementations

- [x] T034 [P] [US1] Implement DiscordChannel in packages/mcp-server/src/channels/discord/DiscordChannel.ts (Discord.js client, bot connection, send/receive messages)
- [x] T035 [P] [US1] Implement SignalRChannel in packages/mcp-server/src/channels/signalr/SignalRChannel.ts (@microsoft/signalr client, hub connection)
- [x] T036 [P] [US1] Implement RedisChannel in packages/mcp-server/src/channels/redis/RedisChannel.ts (ioredis pub/sub, message serialization)

### Message Coordination

- [x] T037 [US1] Implement message routing logic in packages/mcp-server/src/channels/base/ChannelAdapter.ts (broadcast vs unicast, task notifications)
- [x] T038 [US1] Implement task lifecycle event handlers in packages/mcp-server/src/tasks/TaskQueue.ts (task_assigned, task_started, task_completed, task_failed)

### Integration Test

- [x] T039 [US1] Create integration test packages/mcp-server/tests/integration/agent-task-coordination.test.ts (simulates GitHub issue → task assignment → agent coordination workflow)

**Phase 3 Completion Criteria**:
- ✅ GitHub webhooks working (or polling fallback active)
- ✅ Tasks created from GitHub issues
- ✅ Agents receive task assignments
- ✅ Status updates broadcast to all agents
- ✅ Task completion triggers notifications
- ✅ Independent test passes

---

## Phase 4: User Story 4 - Secure Agent Communication (Priority P1)

**Story Goal**: Protect agent communications with authentication and encryption

**Independent Test**:
1. Configure channel with shared token
2. Start agent with correct token → connects successfully
3. Attempt connection with wrong token → rejected
4. Monitor network traffic → verify encryption (TLS)
5. Verify message content unreadable without token

**Test Command**: `npm run test:integration -- --grep="Secure Communication"`

### Authentication

- [ ] T040 [P] [US4] Implement token-based authentication in packages/mcp-server/src/channels/base/ChannelAdapter.ts (validate shared token on connection)
- [ ] T041 [P] [US4] Implement TokenGenerator in packages/mcp-server/src/config/TokenGenerator.ts (generate secure random tokens)
- [ ] T042 [P] [US4] Add authentication middleware to Discord channel in packages/mcp-server/src/channels/discord/DiscordChannel.ts
- [ ] T043 [P] [US4] Add authentication middleware to SignalR channel in packages/mcp-server/src/channels/signalr/SignalRChannel.ts
- [ ] T044 [P] [US4] Add authentication middleware to Redis channel in packages/mcp-server/src/channels/redis/RedisChannel.ts

### Encryption

- [ ] T045 [P] [US4] Configure TLS for SignalR connections in packages/mcp-server/src/channels/signalr/SignalRChannel.ts
- [ ] T046 [P] [US4] Configure TLS for Redis connections in packages/mcp-server/src/channels/redis/RedisChannel.ts (--tls option)

### Relay Server Authentication (Optional Component)

- [ ] T047 [P] [US4] Implement AuthenticationMiddleware in packages/relay-server/src/CoorChat.RelayServer.Api/Middleware/AuthenticationMiddleware.cs
- [ ] T048 [P] [US4] Implement AuthenticationService in packages/relay-server/src/CoorChat.RelayServer.Core/Services/AuthenticationService.cs (validate shared token)

### Security Testing

- [ ] T049 [US4] Create security test packages/mcp-server/tests/integration/secure-communication.test.ts (test authentication rejection, verify encryption)

**Phase 4 Completion Criteria**:
- ✅ Shared token authentication working
- ✅ Unauthorized access blocked
- ✅ TLS/encryption enabled for all channels
- ✅ Network traffic encrypted
- ✅ Independent test passes

---

## Phase 5: User Story 5 - Agent Onboarding and Self-Management (Priority P2)

**Story Goal**: Enable agents to autonomously join, register capabilities, and manage their lifecycle

**Independent Test**:
1. Start new agent with credentials (no manual setup)
2. Agent automatically connects and registers
3. Query agent capabilities → verify advertised correctly
4. Stop agent (disconnect)
5. Restart agent → verify rejoins and restores state

**Test Command**: `npm run test:integration -- --grep="Agent Onboarding"`

### Capability Management

- [ ] T050 [P] [US5] Implement CapabilityManager in packages/mcp-server/src/agents/CapabilityManager.ts (register, discover, query capabilities)
- [ ] T051 [P] [US5] Implement auto-detection of platform/environment in packages/mcp-server/src/agents/CapabilityDetector.ts (OS, environment type, installed tools)
- [ ] T052 [US5] Add capability_query and capability_response message handlers in packages/mcp-server/src/protocol/MessageHandler.ts

### Lifecycle Management

- [ ] T053 [P] [US5] Implement heartbeat mechanism in packages/mcp-server/src/agents/HeartbeatService.ts (15s interval, detect disconnections after 30s)
- [ ] T054 [P] [US5] Implement graceful shutdown handler in packages/mcp-server/src/agents/LifecycleManager.ts (wait for pending tasks, send agent_left message)
- [ ] T055 [P] [US5] Implement reconnection logic with state restoration in packages/mcp-server/src/channels/base/ChannelAdapter.ts (restore agent context, resume tasks)

### Agent Context Persistence

- [ ] T056 [P] [US5] Implement AgentStateStore in packages/mcp-server/src/agents/AgentStateStore.ts (save/load agent state to local file)

### Integration Test

- [ ] T057 [US5] Create integration test packages/mcp-server/tests/integration/agent-onboarding.test.ts (autonomous join, capability registration, reconnection)

**Phase 5 Completion Criteria**:
- ✅ Agents self-register on startup
- ✅ Capabilities auto-detected and advertised
- ✅ Heartbeat keeps connections alive
- ✅ Graceful shutdown works
- ✅ Reconnection restores state
- ✅ Independent test passes

---

## Phase 6: User Story 2 - Human Observer Monitoring (Priority P2)

**Story Goal**: Allow humans to observe agent activities without disrupting workflows

**Independent Test**:
1. Start multiple agents working on tasks
2. Human joins channel as observer
3. Query agent status → verify response shows current tasks
4. View channel history → verify all agent messages visible
5. Distinguish agent roles in messages

**Test Command**: `npm run test:integration -- --grep="Human Observer"`

### MCP Command Interface

- [ ] T058 [P] [US2] Implement CommandHandler in packages/mcp-server/src/mcp/CommandHandler.ts (dispatch /coorchat commands)
- [ ] T059 [P] [US2] Implement StatusCommand in packages/mcp-server/src/mcp/commands/StatusCommand.ts (show channel status, connected agents, active tasks)
- [ ] T060 [P] [US2] Implement CapabilitiesCommand in packages/mcp-server/src/mcp/commands/CapabilitiesCommand.ts (list all agent capabilities)

### Text-based UI

- [ ] T061 [P] [US2] Implement TextUI for status display in packages/mcp-server/src/mcp/ui/TextUI.ts (ASCII tables, box drawing, agent icons)
- [ ] T062 [US2] Format agent status display in packages/mcp-server/src/mcp/ui/AgentStatusFormatter.ts (role, platform, current task, online/offline indicator)

### Observer Mode

- [ ] T063 [P] [US2] Add observer role to AgentRegistry in packages/mcp-server/src/agents/AgentRegistry.ts (passive viewer vs interactive participant)
- [ ] T064 [P] [US2] Implement message history retrieval in packages/mcp-server/src/channels/base/ChannelAdapter.ts (fetch recent messages from channel)

### Integration Test

- [ ] T065 [US2] Create integration test packages/mcp-server/tests/integration/human-observer.test.ts (join as observer, query status, view history)

**Phase 6 Completion Criteria**:
- ✅ /coorchat status command works
- ✅ Text UI displays agent information clearly
- ✅ Observer can view message history
- ✅ Observer doesn't disrupt agent coordination
- ✅ Independent test passes

---

## Phase 7: User Story 3 - System Configuration and Setup (Priority P3)

**Story Goal**: Simplify installation and configuration for administrators

**Independent Test**:
1. Fresh environment (no prior setup)
2. Run /coorchat configure
3. Complete interactive prompts
4. Verify config file created with correct settings
5. Run /coorchat join
6. Verify agent connects successfully

**Test Command**: `npm run test:integration -- --grep="Configuration"`

### MCP Configuration Commands

- [ ] T066 [P] [US3] Implement ConfigureCommand in packages/mcp-server/src/mcp/commands/ConfigureCommand.ts (interactive wizard per mcp-commands.yaml)
- [ ] T067 [P] [US3] Implement JoinCommand in packages/mcp-server/src/mcp/commands/JoinCommand.ts (agent onboarding wizard)
- [ ] T068 [P] [US3] Implement DisconnectCommand in packages/mcp-server/src/mcp/commands/DisconnectCommand.ts (graceful shutdown)

### Interactive Prompts

- [ ] T069 [P] [US3] Implement PromptManager in packages/mcp-server/src/mcp/ui/PromptManager.ts (step-by-step prompts, input validation)
- [ ] T070 [P] [US3] Create channel type selection UI in packages/mcp-server/src/mcp/ui/ChannelSelector.ts (Discord/SignalR/Redis/Relay options)
- [ ] T071 [P] [US3] Create GitHub configuration prompts in packages/mcp-server/src/mcp/ui/GitHubConfigurator.ts (token, repo URL, webhook secret)

### Installation Automation

- [ ] T072 [P] [US3] Create npm post-install script in packages/mcp-server/package.json (initialize config template)
- [ ] T073 [P] [US3] Create config template file .coorchat/config.template.yaml (documented example configuration)

### Integration Test

- [ ] T074 [US3] Create integration test packages/mcp-server/tests/integration/configuration.test.ts (run configure command, validate generated config)

**Phase 7 Completion Criteria**:
- ✅ /coorchat configure creates valid config
- ✅ Interactive prompts guide user through setup
- ✅ /coorchat join connects agent successfully
- ✅ Installation under 5 minutes
- ✅ Independent test passes

---

## Phase 8: Polish & Cross-Cutting Concerns

**Goal**: Production readiness, error handling, performance optimization

### Error Handling & Retry Logic

- [ ] T075 [P] Implement RetryQueue in packages/mcp-server/src/retry/RetryQueue.ts (queue failed messages for retry)
- [ ] T076 [P] Implement ExponentialBackoff in packages/mcp-server/src/retry/ExponentialBackoff.ts (2^n backoff with jitter)
- [ ] T077 [P] Implement RateLimiter in packages/mcp-server/src/retry/RateLimiter.ts (respect GitHub/Discord API rate limits)
- [ ] T078 [P] Add circuit breaker to channel connections in packages/mcp-server/src/channels/base/ChannelAdapter.ts (open after 5 failures, retry after 60s)

### Message History & Retention

- [ ] T079 [P] Implement history retention policies in packages/mcp-server/src/channels/base/ChannelAdapter.ts (purge messages older than configured retention)
- [ ] T080 [P] For Relay Server: Implement MessageRetentionService in packages/relay-server/src/CoorChat.RelayServer.Core/Services/MessageRetentionService.cs (background job, daily purge)

### Performance Optimization

- [ ] T081 [P] Add connection pooling for Redis in packages/mcp-server/src/channels/redis/RedisChannel.ts (reuse connections, lazy initialization)
- [ ] T082 [P] Implement message batching for high-throughput scenarios in packages/mcp-server/src/protocol/MessageBatcher.ts

### Documentation

- [ ] T083 [P] Create API documentation in packages/mcp-server/README.md (usage examples, API reference)
- [ ] T084 [P] Create deployment guide in docs/DEPLOYMENT.md (Docker, npm, environment variables)

### Build & Distribution

- [ ] T085 [P] Optimize Docker images in Dockerfiles (multi-stage build, layer caching, target <200MB)
- [ ] T086 Publish to npm registry (configure package.json, CI/CD pipeline)
- [ ] T087 Publish to DockerHub (configure GitHub Actions workflows, semantic versioning)

**Phase 8 Completion Criteria**:
- ✅ Error handling robust across all channels
- ✅ Rate limiting prevents API quota exhaustion
- ✅ Message retention works correctly
- ✅ Performance meets success criteria (<2s latency, 99.9% delivery)
- ✅ Documentation complete
- ✅ Docker images published
- ✅ npm package published

---

## Parallel Execution Opportunities

### Per User Story

**User Story 1** (Phase 3):
- GitHub integration (T025-T028) can run parallel to Channel implementations (T034-T036)
- Task management (T029-T031) can run parallel to Agent Registry (T032-T033)

**User Story 4** (Phase 4):
- Authentication tasks (T040-T044) are independent per channel, can parallelize
- Relay Server tasks (T047-T048) can run parallel to MCP Server tasks

**User Story 5** (Phase 5):
- Capability management (T050-T052) can run parallel to Lifecycle management (T053-T055)

**User Story 2** (Phase 6):
- All command implementations (T058-T060) can run in parallel
- Text UI components (T061-T062) can run parallel to Observer mode (T063-T064)

**User Story 3** (Phase 7):
- All command implementations (T066-T068) can run in parallel
- All UI components (T069-T071) can run in parallel

**Polish** (Phase 8):
- All error handling tasks (T075-T078) can run in parallel
- All optimization tasks (T081-T082) can run in parallel
- Documentation tasks (T083-T084) can run in parallel

---

## MVP Scope Recommendation

**Minimum Viable Product**: Phases 1-4 (Tasks T001-T049)

This delivers:
- ✅ Core agent coordination (User Story 1)
- ✅ Secure communication (User Story 4)
- ✅ GitHub integration
- ✅ Multi-channel support (Discord, SignalR, Redis)
- ✅ Task assignment and lifecycle
- ✅ Agent registry and roles

**MVP Test Command**: `npm run test:integration -- --grep="MVP"`

**MVP Delivery Time**: ~40-60 hours of focused development

---

## Task Format Validation

✅ All 87 tasks follow the required checklist format:
- `- [ ]` checkbox prefix
- Sequential task IDs (T001-T087)
- [P] marker on 42 parallelizable tasks
- [US#] label on 39 user story tasks
- Clear descriptions with file paths
- Organized by phase/user story

**Format Example**:
```
- [ ] T034 [P] [US1] Implement DiscordChannel in packages/mcp-server/src/channels/discord/DiscordChannel.ts
```

---

## Next Steps

1. **Review task breakdown**: Verify tasks align with specification
2. **Begin implementation**: Start with Phase 1 (Setup)
3. **Track progress**: Check off tasks as completed
4. **Run tests**: Execute integration tests after each phase
5. **Deploy MVP**: After Phase 4 completion

**Recommended command**: `/speckit.implement` to begin execution

---

## Summary

- **Total Tasks**: 87
- **MVP Tasks**: 49 (Phases 1-4)
- **Parallelizable**: 42 tasks marked [P]
- **User Stories**: 5 stories, each independently testable
- **Estimated MVP Time**: 40-60 hours
- **Estimated Full Completion**: 80-120 hours

**All tasks ready for execution. Proceed with `/speckit.implement` to begin development.**
